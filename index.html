// search-engine-server.js
//
// Simple backend search engine skeleton for FindMeACar.
// - Accepts search criteria
// - Calls provider stubs (to be wired to legal APIs/feeds later)
// - Normalises and scores listings
// - Returns ranked results as JSON

const express = require("express");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 4000;

app.use(cors());
app.use(express.json());

/**
 * Types (for clarity, not enforced here)
 *
 * SearchCriteria = {
 *   budgetMin?: number,
 *   budgetMax?: number,
 *   maxMileage?: number,
 *   minYear?: number,
 *   maxYear?: number,
 *   fuelTypes?: string[],
 *   gearboxes?: string[],
 *   bodyStyles?: string[],
 *   location?: string,
 *   radiusMiles?: number
 * }
 *
 * Listing = {
 *   id: string,
 *   source: string,
 *   url: string,
 *   title: string,
 *   price: number,
 *   year: number,
 *   mileage: number,
 *   fuelType?: string,
 *   gearbox?: string,
 *   bodyStyle?: string,
 *   location?: string,
 *   thumbnailUrl?: string,
 *   score?: number,
 *   flags?: string[]
 * }
 */

// --- Provider stubs ------------------------------------------------------
// In future, these will call legal APIs, partner feeds, or your own DB.
// For now, they just return mock data so the engine logic works.

async function providerExampleA(criteria) {
  // TODO: Replace with a real data source (API/feed) when available.
  // Mock data to illustrate the shape:
  return [
    {
      id: "exa-1",
      source: "ExampleSourceA",
      url: "https://example.com/car/exa-1",
      title: "2016 Ford Focus 1.0 EcoBoost",
      price: 7500,
      year: 2016,
      mileage: 68000,
      fuelType: "Petrol",
      gearbox: "Manual",
      bodyStyle: "Hatchback",
      location: "Birmingham",
      thumbnailUrl: "",
    },
    {
      id: "exa-2",
      source: "ExampleSourceA",
      url: "https://example.com/car/exa-2",
      title: "2018 VW Golf 1.6 TDI",
      price: 9800,
      year: 2018,
      mileage: 72000,
      fuelType: "Diesel",
      gearbox: "Manual",
      bodyStyle: "Hatchback",
      location: "Leeds",
      thumbnailUrl: "",
    },
  ];
}

async function providerExampleB(criteria) {
  // Another mock provider - in reality this might be a different API/feed.
  return [
    {
      id: "exb-1",
      source: "ExampleSourceB",
      url: "https://example-b.com/car/exb-1",
      title: "2015 BMW 320d M Sport",
      price: 12000,
      year: 2015,
      mileage: 90000,
      fuelType: "Diesel",
      gearbox: "Automatic",
      bodyStyle: "Saloon",
      location: "Manchester",
      thumbnailUrl: "",
    },
  ];
}

// Helper: apply basic filters from criteria
function filterListingByCriteria(listing, criteria) {
  if (criteria.budgetMin && listing.price < criteria.budgetMin) return false;
  if (criteria.budgetMax && listing.price > criteria.budgetMax) return false;
  if (criteria.maxMileage && listing.mileage > criteria.maxMileage) return false;
  if (criteria.minYear && listing.year < criteria.minYear) return false;
  if (criteria.maxYear && listing.year > criteria.maxYear) return false;

  if (criteria.fuelTypes && criteria.fuelTypes.length > 0) {
    const lt = (listing.fuelType || "").toLowerCase();
    const ok = criteria.fuelTypes.some(f => lt.includes(f.toLowerCase()));
    if (!ok) return false;
  }

  if (criteria.gearboxes && criteria.gearboxes.length > 0) {
    const lg = (listing.gearbox || "").toLowerCase();
    const ok = criteria.gearboxes.some(g => lg.includes(g.toLowerCase()));
    if (!ok) return false;
  }

  if (criteria.bodyStyles && criteria.bodyStyles.length > 0) {
    const lb = (listing.bodyStyle || "").toLowerCase();
    const ok = criteria.bodyStyles.some(b => lb.includes(b.toLowerCase()));
    if (!ok) return false;
  }

  // NOTE: Proper location / radius filtering would need geocoding
  // and coordinates. For now, this is left out.
  return true;
}

// Helper: score a listing according to some simple rules
function scoreListing(listing, criteria) {
  let score = 0;
  const flags = [];

  // Base score: more recent is better
  const currentYear = new Date().getFullYear();
  const age = currentYear - listing.year;
  if (age <= 3) score += 25;
  else if (age <= 5) score += 18;
  else if (age <= 8) score += 12;
  else score += 6;

  // Mileage vs age: rough heuristic
  const milesPerYear = listing.mileage / Math.max(age, 1);
  if (milesPerYear <= 8000) score += 20;
  else if (milesPerYear <= 12000) score += 14;
  else if (milesPerYear <= 16000) score += 8;
  else {
    score += 3;
    flags.push("High mileage for age");
  }

  // Price vs budget window
  if (criteria.budgetMax) {
    const budgetMax = criteria.budgetMax;
    const priceRatio = listing.price / budgetMax;
    if (priceRatio <= 0.7) {
      score += 18;
    } else if (priceRatio <= 0.9) {
      score += 14;
    } else if (priceRatio <= 1.0) {
      score += 8;
    } else {
      flags.push("Above your stated budget");
      score -= 5;
    }
  } else {
    // No upper budget: small neutral boost
    score += 5;
  }

  // Gearbox preference
  if (criteria.gearboxes && criteria.gearboxes.length > 0) {
    const desired = criteria.gearboxes.map(g => g.toLowerCase());
    if (listing.gearbox && desired.includes(listing.gearbox.toLowerCase())) {
      score += 6;
    }
  }

  // Fuel preference
  if (criteria.fuelTypes && criteria.fuelTypes.length > 0) {
    const desired = criteria.fuelTypes.map(f => f.toLowerCase());
    if (listing.fuelType && desired.includes(listing.fuelType.toLowerCase())) {
      score += 6;
    }
  }

  // Simple red flag examples
  if (listing.mileage > 120000) flags.push("Very high mileage");
  if (listing.year < 2010) flags.push("Older vehicle");

  // Clamp score range
  if (score < 0) score = 0;
  if (score > 100) score = 100;

  return { score, flags };
}

// Main search endpoint
app.post("/api/search", async (req, res) => {
  try {
    const criteria = req.body || {};

    // Call all provider stubs in parallel
    const [a, b] = await Promise.all([
      providerExampleA(criteria),
      providerExampleB(criteria),
    ]);

    let allListings = [...a, ...b];

    // Filter by criteria
    allListings = allListings.filter(listing =>
      filterListingByCriteria(listing, criteria)
    );

    // Score listings
    const scored = allListings.map(listing => {
      const { score, flags } = scoreListing(listing, criteria);
      return { ...listing, score, flags };
    });

    // Sort best first
    scored.sort((x, y) => (y.score || 0) - (x.score || 0));

    res.json({
      criteria,
      count: scored.length,
      results: scored,
    });
  } catch (err) {
    console.error("Error in /api/search:", err);
    res.status(500).json({ error: "Something went wrong." });
  }
});

// Health check
app.get("/api/health", (req, res) => {
  res.json({ status: "ok", service: "findmeacar-search-engine" });
});

app.listen(PORT, () => {
  console.log(`FindMeACar search engine running on port ${PORT}`);
});
